## 座席表 実装計画（Konva.js + Plain JS）

### 方針
- 既存コードと極力分離（React不使用、Konva.js 依存のみ）。
- 新規タブ「座席表」を追加し、専用モジュール `js/modules/seatmap/SeatMap.js`（Konva版）を作成。
- 既存の検索〜統合〜表示のロジックは温存。座席表は座席台帳を起点にPC台帳・内線台帳を横断参照。
- 2ペインUI（左: 座席リスト / 右: MAP）。左リストから右MAPへドラッグ&ドロップで座席を追加。

### 依存
- Konva.js（ローカル同梱、`dest/customize-manifest.json` に登録）
- HTML5 Drag & Drop API（左リスト→Stage へのDnDに利用）
- 既存 `js/modules/virtual/VirtualScroll.js` を左リストの大量件数表示に再利用

### kintone フィールド（新規/利用）
- 座席台帳（appId=8）
  - `座席表表示`（radio: `true` / `false`）
  - `座標X`（number）
  - `座標Y`（number）
  - `幅`（number）
  - `高さ`（number）
- 内線台帳（appId=7）
  - `内線番号`（既存）
  - `座席表注記`（1行テキスト／任意）
- PC台帳（既存）
  - `PC番号`（既存）
- 既存フィールド利用
  - `座席拠点`, `階`, `座席番号`, `座席部署`（座席台帳）

### 要件まとめ（Konva.js 版）
- 左右2ペインレイアウト
  - 左: 座席リスト（拠点+階でフィルタ。未配置= `座席表表示=false` を主表示。VirtualScroll対応）
  - 右: MAP（Konva Stage/Layer）。ズーム（±）、パン、リセット
- ドラッグ&ドロップ追加
  - 左リストの座席を右MAPへドラッグ→ドロップ位置に新規配置
  - 配置時に `座席表表示=true`、`X/Y/幅/高さ` を仮設定（保存まではローカル差分保持）
- 表示情報（各座席オブジェクト内）
  - 上段: 座席番号
  - 中段: 内線番号
  - 下段: PC番号
- 座席の描画仕様（テーブル風の内線を含む）
  - 外枠: `Rect`（角丸任意）、ストローク1px
  - 内部線: 水平ライン2本で3行に分割（1/3, 2/3 高さ位置）
  - テキスト: 各行中央寄せ（省略時は空欄表示）。溢れは省略記号
- 操作（編集モード時）
  - ドラッグ移動 / ハンドルでのリサイズ（比率固定は任意設定）
  - 自動整列（グリッド間隔で整列）
  - 削除: MAP上の座席を削除→ `座席表表示=false` に戻し、左リストへ復帰
  - 保存: 変更差分のみ座席台帳へ一括更新（X/Y/幅/高さ/表示）
- パフォーマンス
  - 最大500席の描画・移動に耐えること。編集モード時のみトランスフォーマ/ヒット領域強化を有効化
  - 再描画のスロットリング、Konvaノードのキャッシュ活用
- 色分け
  - 既存ルールフックで将来拡張（本要件では定義のみ、実装は後段）
- フォールバック
  - フォールバック処理は行わない

### UI（座席表タブ）
- 上部コントロール
  - 拠点+階（単一プルダウン、初期選択肢）
    - 例）池袋CO19F, 埼玉CO2F, 埼玉CO3F, 埼玉CO4F, 文京TO2F, 文京TO5F, 浦和TO2F, 浦和TO3F
  - 「表示」ボタン
  - 編集モードON/OFF、削除、自動整列、保存、ズーム±、リセット
- 左カラム（座席リスト）
  - `座席表表示=false` が基本の供給源。検索・絞り込み（座席番号/部署）
  - DnD開始（`dataTransfer` に recordId 等を格納）
- 右カラム（MAP: Konva）
  - Stage 1枚 / Layer 1枚（必要に応じてガイド用Layer）
  - ドロップ受け取り→ステージ座標へ変換→座席グループ生成

### 振る舞い
1) 表示: 座席台帳を「拠点+階+座席表表示=true」で取得 → 統合キーからPC/内線を突合 → 既存座標で描画。`false` は左リストへ
2) 追加: 左からDnD→ `座席表表示=true` と座標/サイズを暫定設定しMAPに生成（未保存フラグ付与）
3) 削除: MAP上の座席を削除→ `座席表表示=false` に戻し、左リストに戻す（未保存フラグ）
4) 編集: ドラッグ&リサイズ（編集モード時のみ）。スナップは任意でグリッドに吸着
5) 自動整列: 行優先の規則配置（最大500席対応）
6) 保存: 変更差分のみ座席台帳へ一括更新（X/Y/幅/高さ/表示）

### 主要コンポーネント
- `SeatMap`（Konva）
  - `init(container)` / `destroy()`
  - `loadAndRender(siteFloor)`（データ取得→描画）
  - `enterEditMode()` / `exitEditMode()`
  - `addSeat(recordId, position?)` / `removeSeat(recordId)`
  - `autoLayout()` / `saveChanges()`
  - `zoomIn()` / `zoomOut()` / `resetView()`
- `SeatList`（左ペイン）
  - `render(container, seats)` / `filter(query)` / `bindDragEvents()`（VirtualScroll活用）
- `DndCoordinator`
  - 左DOMリスト→Konva Stage へのDnD橋渡し（座標変換・受け入れ制御）
- `TabManager` 改修
  - タブメニューに「座席表」を追加
  - `switchTab('seatmap')` で SeatMap / SeatList を初期化/破棄

### 実装手順（段階）
1) Konva.js 追加・manifest登録
2) 2ペインレイアウトのスケルトン（プルダウンと表示ボタン、左リスト、右Stage生成）
3) データ取得と左リスト/右MAPの初期描画（true/false 振り分け）
4) DnD（左→右）と `addSeat` 連携（差分管理）
5) 座席の描画仕様（外枠/内部線/3行テキスト）を実装
6) ドラッグ&リサイズ、自動整列の実装
7) 保存（差分のみ一括更新）
8) ズーム/リセット、パフォーマンス調整（キャッシュ/スロットリング）
9) 色分けフックの追加

### 注意
- 既存コードの改修は最小限（タブ追加/表示切替）。
- CSSで `!important` は安易に使わない。
- 「フォールバック処理」は行わない。

