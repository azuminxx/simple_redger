### ユーザー台帳「貸出管理」機能 仕様書（確定版）

#### 概要
- ユーザー台帳（`CONFIG.userList`）に、物品の貸出・返却履歴を登録・検索・更新する機能を追加する。
- 画面は既存タブに「貸出管理」を追加し、そのタブ内に検索欄と編集可能なテーブルを表示する。
- データソースはKintoneのサブテーブル「貸出管理」。更新はJS＋REST APIで行う。

参考（サブテーブル操作の基本）: [kintoneにおけるテーブル操作の基本（行の追加）](https://cybozu.dev/ja/kintone/tips/development/customize/table/kintone-table-operations-add/)

---

## 確定事項（要件の成文化）
- **対象アプリ**: `js/config.js` の `CONFIG.userList`（ドメイン/AppID/トークンを使用）
- **検索キー**: フィールドコード `BSSID`（一意）
- **サブテーブル**: フィールドコード `貸出管理`
- **サブテーブル内フィールド（全てフィールドコード=ラベルと同一）**
  - 貸出日: 日付（必須、UI初期値は本日）
  - 品名: ドロップダウン（必須、選択肢「モニター」「USB変換」）
  - 型番: 文字列(1行)（任意）
  - 貸出状況: 計算フィールド（Kintone側で自動算出、表示のみ）
  - 返却日: 日付（任意）
  - 備考: 文字列(1行)（任意）
  - 最終更新者: 文字列(1行)（自動入力: `kintone.getLoginUser().name`、表示のみ）
- **UI設置**: 既存タブ群に「貸出管理」を追加。`pages/index.html`は枠のみのため編集しない（JS側でDOM構築）。
- **既存行編集範囲**: 一旦、既存行も全フィールド（表示専用を除く）を編集可能にする。
- **検索入力**: 形式チェックなし。未ヒット時は「該当ユーザーが見つかりません」を表示。

---

## 画面仕様

### タブ
- 既存タブに「貸出管理」を追加。選択時に当タブのビューを表示。

### 検索エリア
- ラベル: BSSID
- 入力: 1行テキスト
- ボタン: 検索
- UX:
  - Enterで検索実行
  - 実行中はローディング表示
  - 0件: 「該当ユーザーが見つかりません」
  - 1件: そのレコードの「貸出管理」サブテーブルを読み込んで下部に描画

### 履歴テーブル（編集可）
- 列構成（左→右）
  - 貸出日（DatePicker、必須）
  - 品名（ドロップダウン: モニター/USB変換、必須）
  - 型番（テキスト）
  - 貸出状況（表示のみ・非編集）
  - 返却日（DatePicker）
  - 備考（テキスト）
  - 最終更新者（表示のみ・非編集、UI表示は行の保存時点の値）
- 行の種別:
  - 既存行: Kintoneのサブテーブル行IDを内部保持
  - 新規行: 一時IDなし。更新時に新規追加として送信
- 行追加:
  - 「貸出行を追加」ボタンで末尾に1行追加
  - 初期値: 貸出日=本日、品名=未選択、型番/返却日/備考=空、最終更新者=ログイン者氏名（表示のみ）
- 操作ボタン:
  - 更新: 変更をKintoneへ一括反映
  - リセット: 未保存変更を破棄し最新を再読込

---

## 振る舞い/フロー

### 検索
1. 入力BSSIDで `records.json` をクエリ（`BSSID = "<入力値>" limit 1`）
2. 取得レコードの `貸出管理` サブテーブル配列をUIテーブルに描画
3. レコードID、`revision` を内部保持（同時更新対策）

### 新規貸出（行追加）
- ボタン押下で未保存行を追加
- 必須（貸出日・品名）を満たすまで更新不可

### 返却・既存行編集
- 既存行は貸出日/品名/型番/返却日/備考を編集可
- 貸出状況・最終更新者は表示のみ（自動）

### 更新（Kintone反映）
- API: PUT `/k/v1/record.json`
- キー: `app`, `id`, `revision`, `record`
- 送信方針（サブテーブル `貸出管理`）:
  - 既存行: `{ id: <row.id>, value: { 貸出日, 品名, 型番, 返却日, 備考, 最終更新者 } }`
  - 新規行: `{ value: { 貸出日, 品名, 型番, 返却日, 備考, 最終更新者 } }`
  - 「貸出状況」は計算フィールドのため送信しない
- `最終更新者`:
  - 送信値は `kintone.getLoginUser().name`
  - 既存行更新時も上書き
- 成功時:
  - レコードを再取得してUI再描画（計算フィールドを最新化）
- 失敗時:
  - `revision` 不一致: エラー表示し再読込案内
  - その他（権限・レート等）: 失敗内容を表示

送信例（概念）
```json
{
  "app": 123,
  "id": 456,
  "revision": 7,
  "record": {
    "貸出管理": {
      "value": [
        { "id": "subRowId1", "value": {
          "貸出日": { "value": "2025-09-18" },
          "品名": { "value": "モニター" },
          "型番": { "value": "ABC-123" },
          "返却日": { "value": "" },
          "備考": { "value": "" },
          "最終更新者": { "value": "山田 太郎" }
        }},
        { "value": {
          "貸出日": { "value": "2025-09-18" },
          "品名": { "value": "USB変換" },
          "型番": { "value": "" },
          "返却日": { "value": "" },
          "備考": { "value": "初回貸出" },
          "最終更新者": { "value": "山田 太郎" }
        }}
      ]
    }
  }
}
```

---

## バリデーション
- 貸出日: 必須（YYYY-MM-DD）
- 品名: 必須（「モニター」「USB変換」）
- 返却日: 任意（入力時は「貸出日」以前にならないこと）
- 型番/備考: 桁数上限の制約は設けない
- BSSID: 形式チェックなし。未ヒット時は「該当ユーザーが見つかりません」

---

## エラーハンドリング
- データなし: 「該当ユーザーが見つかりません」
- 通信/権限/レート/`revision` 不一致: 内容を通知（トースト/アラート）
- 未保存変更ありで再検索/タブ移動: 確認ダイアログ

---

## 開発メモ（既存構成の活用）
- タブ追加: `js/modules/ui/TabManager.js` に「貸出管理」を登録
- 検索UI: `js/modules/ui/SearchAndFilter.js` を流用（BSSID専用の軽微拡張）
- テーブルUI: `js/modules/ui/TableRenderer.js` + `js/modules/ui/FormBuilder.js` で入力テーブルを構築
- API層: `js/modules/api/UserListAPI.js` に以下を追加（既存類似関数がないか確認後に実装）
  - `getRecordByBssid(bssid)`（1件取得）
  - `updateLendingSubtable(appId, recordId, revision, rowsPayload)`
- スクロール最適化が必要な件数の場合のみ `js/modules/virtual/VirtualScroll.js` を適用
- 構成管理: 機密値は `js/config.js` の `CONFIG.userList` を使用

---

## 非機能
- **権限**: Kintone側の権限に依存（編集不可ユーザーは更新不可）
- **操作ログ**: 画面内に成功/失敗の通知。詳細ログは開発者コンソール最小限
- **スタイル**: `!important`は使用しない

---

## 受入基準
- BSSID検索で対象1件が取得され、サブテーブルが一覧表示される
- 「貸出行を追加」→必須入力→「更新」で新規行がKintoneに追加される
- 既存行の編集（例: 返却日入力）→「更新」で該当行が更新される
- 「最終更新者」は更新実行ユーザーの氏名が自動で表示・保存される
- 「貸出状況」は常に表示のみで、再取得後に正しく反映される
- `revision` 不一致時にはエラー表示と再読込案内が出る


